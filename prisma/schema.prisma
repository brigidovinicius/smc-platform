datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?

  accounts           Account[]
  sessions           Session[]
  profile            Profile?
  assets             SaaSAsset[]
  newAssets          Asset[]       @relation("AssetOwner")
  offers             Offer[]       @relation("UserOffers")
  purchases          Offer[]       @relation("UserBuys")
  transactionsSold   Transaction[] @relation("TransactionSeller")
  transactionsBought Transaction[] @relation("TransactionBuyer")
  favorites          Favorite[]    @relation("UserFavorites")
  userBadges         UserBadge[]   @relation("UserBadges")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  role      Role     @default(USER)
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// DEPRECATED: This model is no longer used. All new assets should use the Asset model.
// This table is kept for backward compatibility and data migration purposes.
// TODO: After confirming no production data exists in this table, it can be safely dropped.
model SaaSAsset {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String
  category    String
  mrr         Float?
  arr         Float?
  churnRate   Float?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  offers      Offer[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([ownerId])
}

model Offer {
  id           String        @id @default(cuid())
  assetId      String
  asset        SaaSAsset     @relation(fields: [assetId], references: [id])
  sellerId     String
  seller       User          @relation("UserOffers", fields: [sellerId], references: [id])
  buyerId      String?
  buyer        User?         @relation("UserBuys", fields: [buyerId], references: [id])
  price        Float
  status       OfferStatus   @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
  favorites    Favorite[]    @relation("OfferFavorites")

  @@index([assetId])
  @@index([sellerId])
  @@index([status])
}

model Transaction {
  id        String   @id @default(cuid())
  offerId   String
  offer     Offer    @relation(fields: [offerId], references: [id])
  sellerId  String
  seller    User     @relation("TransactionSeller", fields: [sellerId], references: [id])
  buyerId   String
  buyer     User     @relation("TransactionBuyer", fields: [buyerId], references: [id])
  value     Float
  closedAt  DateTime @default(now())
  createdAt DateTime @default(now())
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  offerId   String
  offer     Offer    @relation("OfferFavorites", fields: [offerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, offerId])
  @@index([userId])
  @@index([offerId])
}

enum Role {
  USER
  ADMIN
}

enum OfferStatus {
  ACTIVE
  UNDER_NEGOTIATION
  SOLD
  ARCHIVED
}

enum AssetType {
  ECOMMERCE
  SAAS
  SOFTWARE
  WEBSITE_CONTENT
  SOCIAL_PROFILE
  NEWSLETTER
  COMMUNITY_MEMBERSHIP
  COURSE_INFOPRODUCT
  HYBRID_BUNDLE
  OTHER
}

enum AssetStatus {
  DRAFT
  SUBMITTED
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
}

enum LeadStatus {
  NEW
  IN_CONTACT
  PROPOSAL_SENT
  WON
  LOST
}

enum LeadBuyerType {
  INVESTOR
  COMPANY
  INDIVIDUAL
  OTHER
}

model Asset {
  id      String @id @default(cuid())
  ownerId String
  owner   User   @relation("AssetOwner", fields: [ownerId], references: [id])

  type   AssetType
  status AssetStatus @default(DRAFT)

  title            String
  slug             String @unique
  shortDescription String
  fullDescription  String

  // Pricing
  askingPrice Float
  currency    String @default("USD")

  // Advisory valuation (suggestive only)
  suggestedMinPrice Float?
  suggestedMaxPrice Float?
  valuationNote     String?

  // Business & performance fields
  monthlyRevenue  Float?
  monthlyProfit   Float?
  mrr             Float?
  arr             Float?
  churnRate       Float?
  cac             Float?
  ltv             Float?
  primaryLanguage String?
  websiteUrl      String?

  // Meta
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  financials   AssetFinancials[]
  performance  AssetPerformance?
  verification AssetVerification?
  moderation   AssetModeration?
  media        AssetMedia[]
  leads        Lead[]
  badges       AssetBadge[] @relation("AssetBadges")

  @@index([ownerId])
  @@index([type])
  @@index([status])
  @@index([slug])
}

model AssetFinancials {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  period   String // e.g. "2025-01", "last_12_months"
  revenue  Float?
  profit   Float?
  expenses Float?

  createdAt DateTime @default(now())

  @@index([assetId])
}

model AssetPerformance {
  id      String @id @default(cuid())
  assetId String @unique
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  monthlyVisitors  Int?
  emailSubscribers Int?
  socialFollowers  Int?
  mainChannels     String? // JSON or comma separated for now

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetVerification {
  id      String @id @default(cuid())
  assetId String @unique
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  flags     String   @default("[]") // JSON array of { code, severity, message }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetModeration {
  id      String @id @default(cuid())
  assetId String @unique
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  adminReviewerId     String?
  adminStatusComment  String?
  adminSuggestedPrice Float?
  adminPricingComment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetMedia {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  url       String
  type      String // "screenshot", "proof", "logo", "deck", etc.
  label     String?
  createdAt DateTime @default(now())

  @@index([assetId])
}

model Lead {
  id          String        @id @default(cuid())
  assetId     String
  asset       Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  name        String
  email       String
  buyerType   LeadBuyerType @default(OTHER)
  budgetRange String?
  message     String
  status      LeadStatus    @default(NEW)
  source      String?       @default("marketplace")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([assetId])
  @@index([status])
  @@index([createdAt])
}

// Admin System Models

model BadgeDefinition {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  type        BadgeType   @default(USER_BADGE)
  automatic   Boolean     @default(false)
  criteria    String?     // JSON string with criteria rules
  icon        String?     // Icon name or URL
  color       String?     // Hex color
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  userBadges UserBadge[]
  assetBadges AssetBadge[]

  @@index([type])
  @@index([slug])
}

enum BadgeType {
  USER_BADGE
  ASSET_BADGE
}

model UserBadge {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation("UserBadges", fields: [userId], references: [id], onDelete: Cascade)
  badgeDefinitionId String
  badgeDefinition   BadgeDefinition @relation(fields: [badgeDefinitionId], references: [id], onDelete: Cascade)
  assignedBy        String?         // Admin user ID who assigned this
  assignedAt        DateTime        @default(now())
  notes             String?

  @@unique([userId, badgeDefinitionId])
  @@index([userId])
  @@index([badgeDefinitionId])
}

model AssetBadge {
  id                String          @id @default(cuid())
  assetId           String
  asset             Asset           @relation("AssetBadges", fields: [assetId], references: [id], onDelete: Cascade)
  badgeDefinitionId String
  badgeDefinition   BadgeDefinition @relation(fields: [badgeDefinitionId], references: [id], onDelete: Cascade)
  assignedBy        String?         // Admin user ID who assigned this
  assignedAt        DateTime        @default(now())
  notes             String?

  @@unique([assetId, badgeDefinitionId])
  @@index([assetId])
  @@index([badgeDefinitionId])
}

model AdminActionLog {
  id          String   @id @default(cuid())
  adminId     String   // User ID of the admin
  action      String   // e.g., "USER_ROLE_CHANGED", "ASSET_APPROVED", "BADGE_ASSIGNED"
  targetType  String?  // "USER", "ASSET", "OFFER", "BADGE", etc.
  targetId    String?  // ID of the target entity
  details     String?  // JSON string with action details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson String   // JSON string value
  category  String?  // e.g., "platform", "pricing", "seo", "features"
  updatedBy String?  // Admin user ID
  updatedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([key])
  @@index([category])
}
